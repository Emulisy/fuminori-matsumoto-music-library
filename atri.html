<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atri</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.2/css/all.min.css" />
    <link rel="stylesheet" href="css/atri.css">
    <link rel="stylesheet" href="css/navbar.css">
    <script src="navbarClick.js"></script>
    <script scr="floatIn.js"></script>
</head>

<body>

    <nav class="navbar">
        <h1 class="navTitle">忘れられない夏が始まる――</h1>
        <ul class="nav-links">
            <li><a href="music library.html">Main</a></li>
            <li><a href="atriSceneChange.html" id="atri">Atri</a></li>
            <li><a href="#">Sakura no Uta</a></li>
            <li><a href="#">Wonderful everyday</a></li>
        </ul>
    </nav>

    <div id="blue-circle"></div>

    <div class = "back-to-top" id="back-to-top"><img src="pic/arrow-up.png"></div>

    <div class="background"><span>Atri</span></div>

    <div class="shell-container">
        <div class="buffer">
            <div id="v-line"></div>
            <div id="buffer-p1" class="text">
                MY DEAR MOMENTS
            </div>
            <div id="buffer-p2" class="text">
                WITH YOU
            </div>
        </div>
        <div class="shell">
            <div class="box">
                <img src="pic/atri_cg/凪.png" alt="Atri">
                <span>凪</span>
            </div>
            <div class="box">
                <img src="pic/atri_cg/海中都市.png" alt="Atri">
                <span>海中都市</span>
            </div>
            <div class="box">
                <img src="pic/atri_cg/暖かな時間.png" alt="Atri">
                <span>暖かな時間</span>
            </div>
            <div class="box">
                <img src="pic/atri_cg/親愛なるあの日々へ.png" alt="Atri">
                <span>親愛なるあの日々へ</span>
            </div>
            <div class="box">
                <img src="pic/atri_cg/光放て!.png" alt="Atri">
                <span>光放て!</span>
            </div>
        </div>

        <div class="music-container" id="music-container">
            <!-- 音乐信息 -->
            <div class="music-info">
                <!-- 音乐标题 -->
                <h4 id="title"></h4>
                <!-- 音乐播放进度条 -->
                <div class="progress-container" id="progress-container">
                    <div class="progress" id="progress"></div>
                </div>
            </div>
    
            <!-- 默认第一首音乐 -->
            <audio src="audio/atri audio/凪.mp3" id="audio"></audio>
    
            <!-- 音乐封面 -->
            <div class="img-container">
                <img src="pic/atri_cg/ev000al.jpg" alt="music-cover" id="music-cover">
            </div>
            <!-- 播放控制 -->
            <div class="navigation">
                <button id="prev" class="action-btn">
                    <i class="fas fa-backward"></i>
                </button>
                <button id="play" class="action-btn action-btn-big">
                    <i class="fas fa-play"></i>
                </button>
                <button id="next" class="action-btn">
                    <i class="fas fa-forward"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="gallery-scroll-box" id="gallery-scroll-box">
        <div class="gallery-container" id="gallery-container">
            <div class="gallery-text-wrapper">
                <h2>Background Gallery</h2>
                <p>Personally, I appreciate the feeling of nature taking over human relics in a post-apocalypse world.
                    This gallery are some pictures I chosen from the ATRI game that I found the most appealing.
                </p>
            </div>

            <div class="scroll-down">Scroll down<img src="pic/chevron-double-down.png"></div>

            <div class="gallery-img-box">
                <img src="pic/atri_bg/bg004e.jpg">
            </div>

            <div class="gallery-img-box">
                <img src="pic/atri_bg/bg001.jpg">
            </div>

            <div class="gallery-img-box">
                <img src="pic/atri_bg/bg005ae.jpg">
            </div>

            <div class="gallery-img-box">
                <img src="pic/atri_bg/bg005e.jpg">
            </div>

            <div class="gallery-img-box">
                <img src="pic/atri_bg/bg006b.jpg">
            </div>

            <div class="gallery-img-box">
                <img src="pic/atri_bg/bg008e.jpg">
            </div>

            <div class="gallery-img-box">
                <img src="pic/atri_bg/bg009.jpg">
            </div>

            <div class="gallery-img-box">
                <img src="pic/atri_bg/bg010e.jpg">
            </div>

            <div class="end-note"><p>More awaits inside ATRI...</p></div>

        </div>
    </div>
</div>

    <script>
        const background = document.querySelector('.background');
        
        // parallax for background
        document.addEventListener('scroll', () => {
            const scrollPosition = window.scrollY;
            
            if(scrollPosition !== 0) {
                background.style.backgroundPosition = `calc(50% + ${scrollPosition}px) calc(50% + ${scrollPosition}px)`;
            } else {
                background.style.backgroundPosition = '';
            }
        });


        document.addEventListener("DOMContentLoaded", () => {
        const vLine = document.getElementById("v-line");

        const observer = new IntersectionObserver(
        ([entry]) => {
            if (entry.isIntersecting) {
            vLine.classList.add("grow");
            }
        },
        { threshold: 0.1 }
        );

        observer.observe(vLine);
        });

        //music control
        const musicContainer = document.getElementById("music-container")
        const playBtn = document.getElementById("play")
        const prevBtn = document.getElementById("prev")
        const nextBtn = document.getElementById("next")

        const audio = document.getElementById("audio")
        const progress = document.getElementById("progress")
        const progressContainer = document.getElementById("progress-container")
        const title = document.getElementById("title")
        const musicCover = document.getElementById("music-cover")

        // 音乐信息
        const songs = ["凪", "光放て!", "Dear Moments", "暖かな時間", "海中都市", "親愛なるあの日々へ", "黄昏期の風景"]
        // 默认从第一首开始
        let songIndex = 0;
        // 将歌曲细节加载到DOM
        loadSong(songs[songIndex])
        // 更新歌曲细节
        function loadSong(song) {
            title.innerHTML = song
            audio.src = `audio/atri audio/${song}.mp3`;     
            musicCover.src = `pic/atri_cg/${song}.png`;
        }

        // 播放歌曲
        function playSong() {
            // 元素添加类名
            musicContainer.classList.add("play")
            playBtn.querySelector('i.fas').classList.remove('fa-play')
            playBtn.querySelector('i.fas').classList.add('fa-pause')

            audio.play()
        }

        // 停止播放
        function pauseSong() {
            musicContainer.classList.remove('play');
            playBtn.querySelector('i.fas').classList.add('fa-play');
            playBtn.querySelector('i.fas').classList.remove('fa-pause');

            audio.pause();
        }

        // 上一首
        function prevSong() {
            songIndex--
            if (songIndex < 0) {
                songIndex = songs.length - 1
            }
            // 加载歌曲信息并播放
            loadSong(songs[songIndex])
            playSong()
        }
        // 下一首
        function nextSong() {
            songIndex++;

            if (songIndex > songs.length - 1) {
                songIndex = 0;
            }

            loadSong(songs[songIndex]);

            playSong();
        }

        // 进度条更新
        function updateProgress(e) {
            // audio.duration: 音频长度
            // audio.currentTime: 音频播放位置
            // 对象解构操作
            const {
                duration,
                currentTime
            } = e.target;
            // e.target = {
            //     duration: 225,  // 当前音频时间长度 
            //     currentTime:0  // 当前播放时间
            // }
            const progressPercent = (currentTime / duration) * 100
            // 进度条
            progress.style.width = `${progressPercent}%`
        }
        // 设置进度条
        function setProgress(e) {
            // progressContainer代理视图宽度
            const width = this.clientWidth
            // 鼠标点击时处于progressContainer里的水平偏移量
            const clickX = e.offsetX

            // audio.duration: 音频长度
            const duration = audio.duration

            // audio.currentTime: 音频播放位置
            audio.currentTime = (clickX / width) * duration
        }
        // 事件监听
        // 1.播放歌曲
        playBtn.onclick = function () {
            // 判断当前是否是正在播放

            // const isPlaying = musicContainer.classList.contains('play')
            // if (isPlaying) {
            //     pauseSong()
            // } else {
            //     playSong()
            // }
            musicContainer.classList.contains('play') ? pauseSong() : playSong()
        }
        // 2.切换歌曲
        prevBtn.onclick = prevSong
        nextBtn.onclick = nextSong

        // 3.播放器进度条相关
        // 3.1 设置播放进度
        progressContainer.onclick = setProgress
        // 3.2 进度条更新
        audio.ontimeupdate = updateProgress
        // 3.3 歌曲结束后自动下一首
        audio.onended = nextSong

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                observer.unobserve(entry.target);
            }
            });
        }, {
            threshold: 0.1,
        });

        window.addEventListener('DOMContentLoaded', () => {
            const elements = document.querySelectorAll('p, h2');
            elements.forEach(el => {
            el.classList.add('animate-on-scroll');
            observer.observe(el);
            });
        });

        const galleryImgObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const imgSrc = entry.target.getAttribute("src");
                // Only update background if it's different from current
                const currentBg = document.getElementById('gallery-scroll-box').style.backgroundImage;
                if (!currentBg.includes(imgSrc)) {
                    document.getElementById('gallery-scroll-box').style.backgroundImage = `url(${imgSrc})`;
                }
            }
        });
        }, {
        root: null,
        threshold: 0.5, // Increased threshold for smoother transitions
        rootMargin: '0px -20% 0px 0px' 
        });

        window.addEventListener('DOMContentLoaded', () => {
            const elements = document.querySelectorAll('.gallery-img-box img');
            elements.forEach(el => {
                galleryImgObserver.observe(el);
            });
        });

    </script>

</body>

</html>


