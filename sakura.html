<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sukura</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.2/css/all.min.css" />
    <link rel="stylesheet" href="css/navbar.css">
    <link rel="stylesheet" href="css/sakura.css">
    <link type="text/css" rel="stylesheet" media="screen" href="css/jquery-sakura.min.css" />
</head>

<body>
    <!-- Split reveal container -->
    <div class="bg-overlay">
        <div class="split-left"></div>
        <div class="split-right"></div>
    </div>

    <nav class="navbar">
        <h1 class="navTitle">櫻の森の上を舞う－</h1>
        <ul class="nav-links">
            <li><a href="index.html">Main</a></li>
            <li><a href="atriSceneChange.html" id="atri">Atri</a></li>
            <li><a href="sakura.html" id="sakura">Sakura no Uta</a></li>
            <li><a href="#">Wonderful everyday</a></li>
        </ul>
    </nav>

    <div id="blue-circle"></div>

    <div class="sakura-container">
        <div id="sakura-left"></div>
        <div id="sakura-right"></div>
    </div>

    <div class="sakura-generator"></div>

    <div class="page1">
        <div class="bg1-container">
            <img src="pic/sakura_cg/p1-background.png" class="bg1">
        </div>
        <div class="trailer">
            <a href="https://www.makura-soft.com/sakuranouta/index.html" target="_blank">
                <img src="pic/img_sakuranouta.png" alt="Sakura no Uta">
            </a>
            <div class="music-container" id="music-container">
                <!-- 音乐信息 -->
                <div class="music-info">
                    <!-- 音乐标题 -->
                    <h4 id="title"></h4>
                    <!-- 音乐播放进度条 -->
                    <div class="progress-container" id="progress-container">
                        <div class="progress" id="progress"></div>
                    </div>
                </div>
        
                <!-- 默认第一首音乐 -->
                <audio id="audio"></audio>
        
                <!-- 音乐封面 -->
                <div class="img-container">
                    <img alt="music-cover" id="music-cover">
                </div>
                <!-- 播放控制 -->
                <div class="navigation">
                    <button id="prev" class="action-btn">
                        <i class="fas fa-backward"></i>
                    </button>
                    <button id="play" class="action-btn action-btn-big">
                        <i class="fas fa-play"></i>
                    </button>
                    <button id="next" class="action-btn">
                        <i class="fas fa-forward"></i>
                    </button>
                </div>
            </div>
            <a href="https://www.makura-soft.com/sakuranotoki/" target="_blank">
                <img src="pic/sakura_no_toki_logo.webp" alt="Sakura no Toki">
            </a>
        </div>

    </div>

    <!-- background image of the galgame -->
     <div class="galgame-page">
        <div class="galgame-container">
            <img class="gal-bg">
            <div class="name-bar"></div>
            <div class="galgame-text-box">
                <p id="gal-diolog"></p>
                <img src="pic/icons8-arrow-down-60.png" class="click-continue">
                <div class="show-text">记录</div>
            </div>
            <div class="show-text-page">
                <div class="show-text-box"></div>
            </div>
        </div>
    </div>

    <div class="page2">
        <ul class="painting-wrapper" type="none">
            <li class="painting-item">
                <div class="painting-img-container">
                    <img src="pic/sakura_painting/easel.png" class="frame easal" >
                    <img src="pic/sakura_painting/静流.png" class="painting vase">
                </div>
            </li>
            <li class="painting-item">
                <div class="painting-img-container">
                    <img src="pic/sakura_painting/frame.png" class="frame" >
                    <img src="pic/sakura_painting/直哉2.png" class="painting">
                </div>
            </li>
            <li class="painting-item">
                <div class="painting-img-container">
                    <img src="pic/sakura_painting/frame.png" class="frame" >
                    <img src="pic/sakura_painting/心铃.png" class="painting">
                </div>
            </li>
            <li class="painting-item">
                <div class="painting-img-container">
                    <img src="pic/sakura_painting/frame.png" class="frame" >
                    <img src="pic/sakura_painting/恩田宁.png" class="painting">
                </div>
            </li>
            <li class="painting-item">
                <div class="painting-img-container">
                    <img src="pic/sakura_painting/frame.png" class="frame" >
                    <img src="pic/sakura_painting/圭.png" class="painting">
                </div>
            </li>
            <li class="painting-item">
                <div class="painting-img-container">
                    <img src="pic/sakura_painting/frame.png" class="frame" >
                    <img src="pic/sakura_painting/直哉.png" class="painting">
                </div>
            </li>
            <li class="painting-item">
                <div class="painting-img-container">
                    <img src="pic/sakura_painting/frame.png" class="frame" >
                    <img src="pic/sakura_painting/樱日狂想.png" class="painting">
                </div>
            </li>
        </ul>
    </div>

    <div class="back-to-top" id="back-to-top"><img src="pic/arrow-up.png"></div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="js/jquery-sakura.min.js"></script>
    <script src="js/navbarClick.js"></script>
    <script>
        // Function to check if all images are loaded
        function checkAllImagesLoaded() {
            return new Promise((resolve) => {
                const images = document.querySelectorAll('img');
                let loadedImages = 0;
                const totalImages = images.length;

                // If there are no images, resolve immediately
                if (totalImages === 0) {
                    resolve();
                    return;
                }

                // Function to check if all images are loaded
                function imageLoaded() {
                    loadedImages++;
                    if (loadedImages === totalImages) {
                        resolve();
                    }
                }

                // Check each image
                images.forEach(img => {
                    // If image is already loaded
                    if (img.complete) {
                        imageLoaded();
                    } else {
                        // If image is still loading
                        img.addEventListener('load', imageLoaded);
                        img.addEventListener('error', imageLoaded); // Also count failed loads
                    }
                });
            });
        }

        // Function to start the overlay animation
        function startOverlayAnimation() {
            const overlay = document.querySelector('.bg-overlay');
            const splitLeft = document.querySelector('.split-left');
            const splitRight = document.querySelector('.split-right');

            // Add reveal classes to trigger the animation
            splitLeft.classList.add('reveal');
            splitRight.classList.add('reveal');

            // Hide the overlay after animation completes
            setTimeout(() => {
                overlay.classList.add('hide');
            }, 1500);
        }

        // Wait for DOM and all resources to load
        window.addEventListener('load', async function() {
            // Wait for all images to load
            await checkAllImagesLoaded();
            
            // Start the overlay animation
            startOverlayAnimation();
        });
        

        jQuery(document).ready(function($) {
            // Initialize sakura effect
            $('.sakura-generator').sakura();

            
            // galgame page start
            const diolog = document.querySelector("#gal-diolog");
            const galName = document.querySelector(".name-bar")
            const galBg = document.querySelector(".gal-bg")
            const leftCharacter = document.querySelector('.character-box-left')
            const rightCharacter = document.querySelector(".character-box-right")
            let diologText = [];
            let nameText = [];
            let galProcessIndex = 0;
            let writeInterval;
            let bgImg = [];

            // Load the dialogue when document is ready
            loadDialogue();

            // Fetch and load the dialogue from text.json
            async function loadDialogue() {
                try {
                    const response = await fetch('text.json');
                    const data = await response.json();
                    
                    // Process the JSON data into our arrays
                    diologText = data.map(item => {
                        const [speaker, content] = Object.entries(item)[0];
                        return content.text.replace(/^「|」$/g, ''); // Remove the 「」 quotes
                    });
                    
                    nameText = data.map(item => {
                        const [speaker] = Object.entries(item)[0];
                        // Map speaker names to display names
                        switch(speaker) {
                            case '圭': return '夏目圭';
                            case '心鈴': return '本间心铃';
                            case '旁白': return '';
                            default: return speaker;
                        }
                    });

                    // Store background images
                    bgImg = data.map(item => {
                        const [speaker, content] = Object.entries(item)[0];
                        return content.bg || ''; // Return empty string if no bg specified
                    });

                    // Set up initial state
                    galName.textContent = nameText[0];
                    if (bgImg[0] && bgImg[0].trim() !== "") {
                        galBg.src = bgImg[0];
                    }
                    // Start with first text after loading
                    startWriting();
                } catch (error) {
                    console.error('Error loading dialogue:', error);
                }
            }

            // Function to update dialog history
            function updateDialogHistory() {
                const showTextBox = document.querySelector('.show-text-box');
                showTextBox.innerHTML = ''; // Clear existing content
                
                // Add all dialogs up to current index
                for (let i = 0; i <= galProcessIndex; i++) {
                    const dialogDiv = document.createElement('div');
                    dialogDiv.style.marginBottom = '15px';
                    dialogDiv.style.padding = '10px';
                    
                    // Add name if it exists
                    if (nameText[i]) {
                        const nameDiv = document.createElement('div');
                        nameDiv.style.fontWeight = 'bold';
                        nameDiv.style.color = '#ff69b4';
                        nameDiv.style.marginBottom = '5px';
                        nameDiv.textContent = nameText[i];
                        dialogDiv.appendChild(nameDiv);
                    }
                    
                    // Add dialog text
                    const textDiv = document.createElement('div');
                    textDiv.style.lineHeight = '1.5';
                    textDiv.textContent = diologText[i];
                    dialogDiv.appendChild(textDiv);
                    
                    showTextBox.appendChild(dialogDiv);
                }
                
                // Scroll to bottom of the history
                showTextBox.scrollTop = showTextBox.scrollHeight;
            }

            // Update the startWriting function to also update history
            function startWriting() {
                // Clear any existing text and interval
                diolog.innerHTML = '';
                if (writeInterval) {
                    clearInterval(writeInterval);
                }

                // Get current text and split it
                let words = diologText[galProcessIndex].split("");
                let currentIndex = 0;

                function write() {
                    if (currentIndex < words.length) {
                        let span = document.createElement("span");
                        span.innerHTML = words[currentIndex];
                        diolog.appendChild(span);
                        currentIndex++;
                    } else {
                        clearInterval(writeInterval);
                        // Update dialog history after text is fully written
                        updateDialogHistory();
                    }
                }

                writeInterval = setInterval(write, 50);
            }

            // Update the click handler to also update history when showing
            document.querySelector('.show-text').addEventListener('click', function(event) {
                event.stopPropagation();
                
                const showTextPage = document.querySelector('.show-text-page');
                if (showTextPage.style.opacity === '1') {
                    showTextPage.style.opacity = '0';
                    showTextPage.style.pointerEvents = 'none';
                } else {
                    showTextPage.style.opacity = '1';
                    showTextPage.style.pointerEvents = 'auto';
                    // Update history when showing the box
                    updateDialogHistory();
                }
            });

            // Handle click to change text
            document.querySelector(".galgame-container").addEventListener("click", function() {
                if (galProcessIndex < diologText.length - 1) {
                    galProcessIndex++; // Increment index first
                    startWriting();
                    galName.textContent = nameText[galProcessIndex];
                    
                    // Handle background changes if needed
                    const currentBg = bgImg[galProcessIndex];
                    if (currentBg && currentBg.trim() !== "") {
                        galBg.src = currentBg;
                    }
                }
            });
        });


        //galgame page end-

        const paintingPage = document.querySelector(".page2")
        const paintings = document.querySelectorAll(".painting")
        const frames = document.querySelectorAll(".frame")

        // Add perspective to the container
        document.querySelector('.painting-wrapper').style.perspective = '1000px';

        paintingPage.addEventListener("mousemove", function(e) {
            // Get mouse position relative to the page
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            
            // Get page dimensions
            const pageRect = paintingPage.getBoundingClientRect();
            
            // Calculate center of the page
            const centerX = pageRect.left + pageRect.width / 2;
            const centerY = pageRect.top + pageRect.height / 2;
            
            // Calculate distance from center (normalized to -1 to 1)
            const moveX = (mouseX - centerX) / (pageRect.width / 2);
            const moveY = (mouseY - centerY) / (pageRect.height / 2);
            
            // Apply movement to each painting with different intensities
            paintings.forEach((painting, index) => {
                // Different movement intensity for each painting
                const intensity = 0.05 + (index * 0.02); // Varies from 0.05 to 0.15
                
                // Calculate transform values
                const translateX = moveX * intensity * 100; // Convert to pixels
                const translateY = moveY * intensity * 100;
                
                // Calculate 3D rotation (lean towards cursor)
                // Using negative values because we want to lean towards the cursor
                const rotateY = -moveX * (2 + index * 0.5); // Varies from 2 to 4 degrees
                const rotateX = moveY * (2 + index * 0.5); // Varies from 2 to 4 degrees
                
                // Check if painting is being hovered
                const isHovered = painting.matches(':hover');
                const scale = isHovered ? (painting.classList.contains('vase') ? 1.15 : 1.1) : 1;
                
                // Apply transform with translation, 3D rotation, and scale
                painting.style.transform = `translate(${translateX}px, ${translateY}px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(${scale})`;
                painting.style.transition = 'transform 0.2s ease-out';
                // Add some depth to the paintings
                painting.style.transformStyle = 'preserve-3d';
            });

            // Apply movement to frames with lower intensity (no 3D rotation for frames)
            frames.forEach((frame, index) => {
                // Frame movement intensity is half of the painting intensity
                const intensity = (0.01 + (index * 0.02)) * 0.3; // Varies from 0.025 to 0.075
                
                // Calculate transform values
                const translateX = moveX * intensity * 100;
                const translateY = moveY * intensity * 100;
                
                // Apply transform with smooth transition
                frame.style.transform = `translate(${translateX}px, ${translateY}px)`;
                frame.style.transition = 'transform 0.1s ease-out';
            });
        });

        // Reset paintings and frames position when mouse leaves the page
        paintingPage.addEventListener("mouseleave", function() {
            paintings.forEach(painting => {
                painting.style.transform = 'translate(0px, 0px) rotateX(0deg) rotateY(0deg)';
            });
            frames.forEach(frame => {
                frame.style.transform = 'translate(0px, 0px)';
            });
        });


        // 音乐信息
        const songs = ["櫻ノ詩 (OP short ver)", "交差視覚の季節", "刻ト詩 - OP Short ver -", "刻の繭の外へ", "向日葵の嵐が過ぎ去り", 
        "吹き上がる音と言葉", "夢水の調べ", "木履と横道", "欠けた絵画は盈ちて", "筆射す光"
        , "美しい音色で世界が鳴った", "舞い降りる風景画", "風景はせはしく明滅し"
    ]
        // Get DOM elements
        const title = document.getElementById('title');
        const audio = document.getElementById('audio');
        const musicCover = document.getElementById('music-cover');
        const musicContainer = document.getElementById('music-container');
        const playBtn = document.getElementById('play');
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
        const progress = document.getElementById('progress');
        const progressContainer = document.getElementById('progress-container');

        // 默认从第一首开始
        let songIndex = 0;
        // 将歌曲细节加载到DOM
        loadSong(songs[songIndex])
        // 更新歌曲细节
        function loadSong(song) {
            title.textContent = song;
            audio.src = `audio/sakura audio/${song}.mp3`;     
            musicCover.src = `audio/sakura audio/${song}.png`;
        }

        // 播放歌曲
        function playSong() {
            // 元素添加类名
            musicContainer.classList.add("play")
            playBtn.querySelector('i.fas').classList.remove('fa-play')
            playBtn.querySelector('i.fas').classList.add('fa-pause')

            audio.play()
        }

        // 停止播放
        function pauseSong() {
            musicContainer.classList.remove('play');
            playBtn.querySelector('i.fas').classList.add('fa-play');
            playBtn.querySelector('i.fas').classList.remove('fa-pause');

            audio.pause();
        }

        // 上一首
        function prevSong() {
            songIndex--
            if (songIndex < 0) {
                songIndex = songs.length - 1
            }
            // 加载歌曲信息并播放
            loadSong(songs[songIndex])
            playSong()
        }
        // 下一首
        function nextSong() {
            songIndex++;

            if (songIndex > songs.length - 1) {
                songIndex = 0;
            }

            loadSong(songs[songIndex]);

            playSong();
        }

        // 进度条更新
        function updateProgress(e) {
            // audio.duration: 音频长度
            // audio.currentTime: 音频播放位置
            // 对象解构操作
            const {
                duration,
                currentTime
            } = e.target;
            // e.target = {
            //     duration: 225,  // 当前音频时间长度 
            //     currentTime:0  // 当前播放时间
            // }
            const progressPercent = (currentTime / duration) * 100
            // 进度条
            progress.style.width = `${progressPercent}%`
        }
        // 设置进度条
        function setProgress(e) {
            // progressContainer代理视图宽度
            const width = this.clientWidth
            // 鼠标点击时处于progressContainer里的水平偏移量
            const clickX = e.offsetX

            // audio.duration: 音频长度
            const duration = audio.duration

            // audio.currentTime: 音频播放位置
            audio.currentTime = (clickX / width) * duration
        }
        // 事件监听
        // 1.播放歌曲
        playBtn.onclick = function () {
            // 判断当前是否是正在播放

            // const isPlaying = musicContainer.classList.contains('play')
            // if (isPlaying) {
            //     pauseSong()
            // } else {
            //     playSong()
            // }
            musicContainer.classList.contains('play') ? pauseSong() : playSong()
        }
        // 2.切换歌曲
        prevBtn.onclick = prevSong
        nextBtn.onclick = nextSong

        // 3.播放器进度条相关
        // 3.1 设置播放进度
        progressContainer.onclick = setProgress
        // 3.2 进度条更新
        audio.ontimeupdate = updateProgress
        // 3.3 歌曲结束后自动下一首
        audio.onended = nextSong
    </script>
</body>
</html>